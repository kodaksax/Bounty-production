##############################################################################
# BountyExpo – Production Docker Compose
#
# Redis Cluster topology
# ┌──────────────────────────────────────┐
# │  3 master nodes + 3 replica nodes   │
# │                                      │
# │  redis-cluster-1  (master, :6379)   │
# │  redis-cluster-2  (master, :6380)   │
# │  redis-cluster-3  (master, :6381)   │
# │  redis-cluster-4  (replica, :6382)  │
# │  redis-cluster-5  (replica, :6383)  │
# │  redis-cluster-6  (replica, :6384)  │
# └──────────────────────────────────────┘
#
# The `redis-cluster-init` service bootstraps the cluster the first time it
# runs, then exits.  On subsequent `docker compose up` calls it detects that
# the cluster is already healthy and skips re-initialisation (idempotent).
#
# Usage:
#   docker compose -f docker-compose.prod.yml up -d
#
# Required environment variables (set in .env or the host environment):
#   REDIS_PASSWORD  – shared password for all cluster nodes (required)
##############################################################################

services:

  # ──────────────────────────────────────────────────────────────────────────
  # Redis Cluster nodes
  # ──────────────────────────────────────────────────────────────────────────

  redis-cluster-1:
    image: redis:7-alpine
    container_name: bountyexpo-redis-cluster-1
    # REDIS_PASSWORD is required.  Docker Compose will abort with a clear error
    # if it is not set in the environment or .env file.
    environment:
      - REDISCLI_AUTH=${REDIS_PASSWORD:?REDIS_PASSWORD environment variable is required}
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file /data/nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
      --port 6379
    ports:
      - "6379:6379"
    volumes:
      - redis_cluster_1_data:/data
    healthcheck:
      # Use REDISCLI_AUTH env var so the password is never exposed in the
      # process argument list.
      test: ["CMD", "redis-cli", "--no-auth-warning", "-p", "6379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bountyexpo-cluster-network

  redis-cluster-2:
    image: redis:7-alpine
    container_name: bountyexpo-redis-cluster-2
    environment:
      - REDISCLI_AUTH=${REDIS_PASSWORD:?REDIS_PASSWORD environment variable is required}
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file /data/nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
      --port 6380
    ports:
      - "6380:6380"
    volumes:
      - redis_cluster_2_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-p", "6380", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bountyexpo-cluster-network

  redis-cluster-3:
    image: redis:7-alpine
    container_name: bountyexpo-redis-cluster-3
    environment:
      - REDISCLI_AUTH=${REDIS_PASSWORD:?REDIS_PASSWORD environment variable is required}
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file /data/nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
      --port 6381
    ports:
      - "6381:6381"
    volumes:
      - redis_cluster_3_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-p", "6381", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bountyexpo-cluster-network

  redis-cluster-4:
    image: redis:7-alpine
    container_name: bountyexpo-redis-cluster-4
    environment:
      - REDISCLI_AUTH=${REDIS_PASSWORD:?REDIS_PASSWORD environment variable is required}
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file /data/nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
      --port 6382
    ports:
      - "6382:6382"
    volumes:
      - redis_cluster_4_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-p", "6382", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bountyexpo-cluster-network

  redis-cluster-5:
    image: redis:7-alpine
    container_name: bountyexpo-redis-cluster-5
    environment:
      - REDISCLI_AUTH=${REDIS_PASSWORD:?REDIS_PASSWORD environment variable is required}
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file /data/nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
      --port 6383
    ports:
      - "6383:6383"
    volumes:
      - redis_cluster_5_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-p", "6383", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bountyexpo-cluster-network

  redis-cluster-6:
    image: redis:7-alpine
    container_name: bountyexpo-redis-cluster-6
    environment:
      - REDISCLI_AUTH=${REDIS_PASSWORD:?REDIS_PASSWORD environment variable is required}
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file /data/nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
      --port 6384
    ports:
      - "6384:6384"
    volumes:
      - redis_cluster_6_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-p", "6384", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bountyexpo-cluster-network

  # ──────────────────────────────────────────────────────────────────────────
  # Cluster initialisation (runs once, then exits)
  # ──────────────────────────────────────────────────────────────────────────

  redis-cluster-init:
    image: redis:7-alpine
    container_name: bountyexpo-redis-cluster-init
    environment:
      - REDISCLI_AUTH=${REDIS_PASSWORD:?REDIS_PASSWORD environment variable is required}
    depends_on:
      redis-cluster-1:
        condition: service_healthy
      redis-cluster-2:
        condition: service_healthy
      redis-cluster-3:
        condition: service_healthy
      redis-cluster-4:
        condition: service_healthy
      redis-cluster-5:
        condition: service_healthy
      redis-cluster-6:
        condition: service_healthy
    # --cluster-replicas 1  → 1 replica per master  (3 masters + 3 replicas)
    # Idempotent: skips creation when the cluster is already in an ok state.
    # Service names are used (Docker DNS) so no static IPs are required.
    command: >
      sh -c "
        if redis-cli --no-auth-warning -h redis-cluster-1 -p 6379 CLUSTER INFO | grep -q 'cluster_state:ok'; then
          echo 'Redis cluster already initialized, skipping cluster creation';
        else
          redis-cli --no-auth-warning --cluster create
            redis-cluster-1:6379
            redis-cluster-2:6380
            redis-cluster-3:6381
            redis-cluster-4:6382
            redis-cluster-5:6383
            redis-cluster-6:6384
            --cluster-replicas 1
            --cluster-yes;
        fi
      "
    networks:
      - bountyexpo-cluster-network
    restart: "no"

# ──────────────────────────────────────────────────────────────────────────
# Volumes
# ──────────────────────────────────────────────────────────────────────────

volumes:
  redis_cluster_1_data:
    driver: local
  redis_cluster_2_data:
    driver: local
  redis_cluster_3_data:
    driver: local
  redis_cluster_4_data:
    driver: local
  redis_cluster_5_data:
    driver: local
  redis_cluster_6_data:
    driver: local

# ──────────────────────────────────────────────────────────────────────────
# Networks
# ──────────────────────────────────────────────────────────────────────────

networks:
  bountyexpo-cluster-network:
    driver: bridge
