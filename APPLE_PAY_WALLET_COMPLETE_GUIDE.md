# Complete Apple Pay & Apple Wallet Integration Guide for BountyExpo

## Table of Contents

1. [Overview](#overview)
2. [Apple Pay Integration](#apple-pay-integration)
3. [Apple Wallet Card Integration](#apple-wallet-card-integration)
4. [Prerequisites](#prerequisites)
5. [Backend Setup](#backend-setup)
6. [Frontend Implementation](#frontend-implementation)
7. [Testing](#testing)
8. [Production Deployment](#production-deployment)
9. [External Stripe Integration](#external-stripe-integration)
10. [Troubleshooting](#troubleshooting)

---

## Overview

This guide covers two main integrations:

1. **Apple Pay** - Native iOS payment method for funding bounties and wallet deposits
2. **Apple Wallet** - Digital wallet cards for storing transaction receipts and passes

### Benefits

- **Apple Pay**: One-tap payments with biometric authentication, higher conversion rates
- **Apple Wallet**: Convenient receipt storage, push notifications for transaction updates

---

## Apple Pay Integration

### Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    APPLE PAY PAYMENT FLOW                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

User Taps "Pay with Apple Pay"
         ‚Üì
iOS Payment Sheet Presented
         ‚Üì
User Authenticates (Face ID/Touch ID)
         ‚Üì
Payment Token Generated by Apple
         ‚Üì
Token Sent to Your Backend
         ‚Üì
Backend Creates Stripe PaymentIntent
         ‚Üì
Backend Confirms Payment with Token
         ‚Üì
Stripe Processes Payment
         ‚Üì
Success/Failure Response
         ‚Üì
UI Updated + Email Receipt Sent
```

### Step 1: Apple Developer Account Setup

#### 1.1 Create Merchant ID

1. Go to [Apple Developer Portal](https://developer.apple.com/account)
2. Navigate to **Certificates, Identifiers & Profiles**
3. Select **Identifiers** ‚Üí Click **+** button
4. Choose **Merchant IDs** ‚Üí Continue
5. Create merchant ID:
   ```
   Identifier: merchant.com.bountyexpo.payments
   Description: BountyExpo Payment Processing
   ```
6. Click **Register**

#### 1.2 Create Payment Processing Certificate

1. In Merchant ID details, click **Create Certificate**
2. Follow Apple's Certificate Signing Request (CSR) process
3. Download the certificate
4. Note: This certificate is used for Apple Pay but managed by Stripe

#### 1.3 Enable Apple Pay in Xcode Project

Edit `ios/BountyExpo.entitlements`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <!-- Add Apple Pay capability -->
    <key>com.apple.developer.in-app-payments</key>
    <array>
        <string>merchant.com.bountyexpo.payments</string>
    </array>
</dict>
</plist>
```

#### 1.4 Update app.json

```json
{
  "expo": {
    "name": "BountyExpo",
    "slug": "bountyexpo",
    "ios": {
      "bundleIdentifier": "com.bountyexpo.app",
      "merchantId": "merchant.com.bountyexpo.payments",
      "infoPlist": {
        "NSApplePayCapability": "production"
      },
      "config": {
        "usesNonExemptEncryption": false
      }
    }
  }
}
```

### Step 2: Stripe Configuration for Apple Pay

#### 2.1 Register Your Merchant ID with Stripe

1. **Stripe Dashboard** ‚Üí Settings ‚Üí Payments
2. Navigate to **Apple Pay** section
3. Click **Add your Apple Merchant ID**
4. Enter: `merchant.com.bountyexpo.payments`
5. Follow Stripe's domain verification process

#### 2.2 Configure Stripe in Backend

Update `services/api/.env`:

```bash
# Stripe Keys
STRIPE_SECRET_KEY=sk_test_your_key_here
STRIPE_PUBLISHABLE_KEY=pk_test_your_key_here

# Apple Pay Configuration
APPLE_MERCHANT_ID=merchant.com.bountyexpo.payments
APPLE_PAY_ENABLED=true
```

### Step 3: Backend Implementation

#### 3.1 Create Apple Pay PaymentIntent Endpoint

Create `services/api/src/routes/apple-pay.ts`:

```typescript
import { FastifyInstance } from 'fastify';
import { authMiddleware, AuthenticatedRequest } from '../middleware/auth';
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2023-10-16',
});

export async function registerApplePayRoutes(fastify: FastifyInstance) {
  /**
   * Create PaymentIntent for Apple Pay
   */
  fastify.post('/apple-pay/payment-intent', {
    preHandler: authMiddleware
  }, async (request: AuthenticatedRequest, reply) => {
    try {
      const { amountCents, bountyId, description } = request.body as {
        amountCents: number;
        bountyId?: string;
        description?: string;
      };

      if (!request.userId) {
        return reply.code(401).send({ error: 'Unauthorized' });
      }

      // Validate amount
      if (!amountCents || amountCents < 50) {
        return reply.code(400).send({
          error: 'Amount must be at least $0.50'
        });
      }

      // Create PaymentIntent with Apple Pay
      const paymentIntent = await stripe.paymentIntents.create({
        amount: amountCents,
        currency: 'usd',
        payment_method_types: ['card'], // Apple Pay uses card payment method
        metadata: {
          user_id: request.userId,
          bounty_id: bountyId || '',
          payment_method: 'apple_pay',
        },
        description: description || 'BountyExpo Payment',
      });

      return {
        clientSecret: paymentIntent.client_secret,
        paymentIntentId: paymentIntent.id,
      };
    } catch (error) {
      console.error('Error creating Apple Pay payment intent:', error);
      return reply.code(500).send({
        error: 'Failed to create payment intent'
      });
    }
  });

  /**
   * Confirm Apple Pay payment
   */
  fastify.post('/apple-pay/confirm', {
    preHandler: authMiddleware
  }, async (request: AuthenticatedRequest, reply) => {
    try {
      const { paymentIntentId, bountyId } = request.body as {
        paymentIntentId: string;
        bountyId?: string;
      };

      if (!request.userId) {
        return reply.code(401).send({ error: 'Unauthorized' });
      }

      // Retrieve payment intent to check status
      const paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId);

      if (paymentIntent.status === 'succeeded') {
        // Payment successful - record transaction
        // Add to wallet, send email receipt, etc.

        return {
          success: true,
          status: paymentIntent.status,
          amount: paymentIntent.amount,
        };
      } else {
        return {
          success: false,
          status: paymentIntent.status,
          error: 'Payment not completed',
        };
      }
    } catch (error) {
      console.error('Error confirming Apple Pay payment:', error);
      return reply.code(500).send({
        error: 'Failed to confirm payment'
      });
    }
  });
}
```

#### 3.2 Register Apple Pay Routes

Update `services/api/src/index.ts`:

```typescript
import { registerApplePayRoutes } from './routes/apple-pay';

// After other route registrations
await registerApplePayRoutes(fastify);
```

### Step 4: Frontend Implementation

#### 4.1 Initialize Stripe with Apple Pay

Update `App.tsx` or root provider:

```typescript
import { StripeProvider } from '@stripe/stripe-react-native';

export default function App() {
  return (
    <StripeProvider
      publishableKey={process.env.EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY!}
      merchantIdentifier="merchant.com.bountyexpo.payments"
      urlScheme="bountyexpo" // For returning from external payment flow
    >
      {/* Your app components */}
    </StripeProvider>
  );
}
```

#### 4.2 Create Apple Pay Service

Create `lib/services/apple-pay-service.ts`:

```typescript
import { Platform } from 'react-native';
import {
  presentApplePay,
  confirmApplePayPayment,
  ApplePay,
  ApplePayError,
  StripeError,
} from '@stripe/stripe-react-native';

export interface ApplePayPaymentRequest {
  amount: number; // in dollars
  description: string;
  bountyId?: string;
}

export interface ApplePayResult {
  success: boolean;
  paymentIntentId?: string;
  error?: string;
  errorCode?: string;
}

class ApplePayService {
  /**
   * Check if Apple Pay is available on this device
   */
  async isAvailable(): Promise<boolean> {
    if (Platform.OS !== 'ios') {
      return false;
    }

    try {
      const canMakePayments = await ApplePay.isApplePaySupported();
      return canMakePayments;
    } catch (error) {
      console.error('Error checking Apple Pay availability:', error);
      return false;
    }
  }

  /**
   * Process payment with Apple Pay
   */
  async processPayment(request: ApplePayPaymentRequest): Promise<ApplePayResult> {
    try {
      // Step 1: Create PaymentIntent on backend
      const response = await fetch(`${API_BASE_URL}/apple-pay/payment-intent`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${await getAuthToken()}`,
        },
        body: JSON.stringify({
          amountCents: Math.round(request.amount * 100),
          bountyId: request.bountyId,
          description: request.description,
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to create payment intent');
      }

      const { clientSecret, paymentIntentId } = await response.json();

      // Step 2: Present Apple Pay sheet
      const { error: presentError } = await presentApplePay({
        cartItems: [
          {
            label: request.description,
            amount: request.amount.toFixed(2),
            type: 'final',
          },
        ],
        country: 'US',
        currency: 'USD',
        requiredShippingAddressFields: [],
        requiredBillingContactFields: ['postalAddress'],
      });

      if (presentError) {
        console.error('Apple Pay presentation error:', presentError);
        
        // Handle user cancellation separately
        if (presentError.code === ApplePayError.Canceled) {
          return {
            success: false,
            error: 'Payment cancelled by user',
            errorCode: 'cancelled',
          };
        }

        return {
          success: false,
          error: presentError.message,
          errorCode: presentError.code,
        };
      }

      // Step 3: Confirm payment with the client secret
      const { error: confirmError } = await confirmApplePayPayment(clientSecret);

      if (confirmError) {
        console.error('Apple Pay confirmation error:', confirmError);
        return {
          success: false,
          error: confirmError.message,
          errorCode: confirmError.code,
        };
      }

      // Step 4: Verify payment on backend
      const confirmResponse = await fetch(`${API_BASE_URL}/apple-pay/confirm`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${await getAuthToken()}`,
        },
        body: JSON.stringify({
          paymentIntentId,
          bountyId: request.bountyId,
        }),
      });

      const confirmResult = await confirmResponse.json();

      if (confirmResult.success) {
        return {
          success: true,
          paymentIntentId,
        };
      } else {
        return {
          success: false,
          error: confirmResult.error || 'Payment confirmation failed',
        };
      }

    } catch (error) {
      console.error('Apple Pay payment error:', error);
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error',
      };
    }
  }
}

// Export singleton
export const applePayService = new ApplePayService();

// Helper function to get auth token (implement based on your auth system)
async function getAuthToken(): Promise<string> {
  // Get token from secure storage or auth provider
  return 'your-auth-token';
}

const API_BASE_URL = process.env.EXPO_PUBLIC_API_URL || 'http://localhost:3001';
```

#### 4.3 Update Add Money Screen

Update `components/AddMoneyScreen.tsx`:

```typescript
import React, { useState, useEffect } from 'react';
import { View, Text, TouchableOpacity, Alert, ActivityIndicator } from 'react-native';
import { MaterialIcons } from '@expo/vector-icons';
import { applePayService } from '../lib/services/apple-pay-service';

export function AddMoneyScreen({ onBack, onAddMoney }) {
  const [amount, setAmount] = useState('0');
  const [isProcessing, setIsProcessing] = useState(false);
  const [isApplePayAvailable, setIsApplePayAvailable] = useState(false);

  useEffect(() => {
    checkApplePayAvailability();
  }, []);

  const checkApplePayAvailability = async () => {
    const available = await applePayService.isAvailable();
    setIsApplePayAvailable(available);
  };

  const handleApplePayPress = async () => {
    const numAmount = parseFloat(amount);
    
    if (isNaN(numAmount) || numAmount <= 0) {
      Alert.alert('Invalid Amount', 'Please enter a valid amount');
      return;
    }

    if (numAmount < 0.50) {
      Alert.alert('Minimum Amount', 'Amount must be at least $0.50');
      return;
    }

    setIsProcessing(true);

    try {
      const result = await applePayService.processPayment({
        amount: numAmount,
        description: 'Add Money to Wallet',
      });

      if (result.success) {
        Alert.alert(
          'Success!',
          `$${numAmount.toFixed(2)} has been added to your wallet via Apple Pay.`,
          [
            {
              text: 'OK',
              onPress: () => {
                onAddMoney?.(numAmount);
                onBack?.();
              },
            },
          ]
        );
      } else if (result.errorCode === 'cancelled') {
        // User cancelled - no error alert needed
        console.log('Apple Pay cancelled by user');
      } else {
        Alert.alert(
          'Payment Failed',
          result.error || 'Unable to process Apple Pay payment.',
          [{ text: 'OK' }]
        );
      }
    } catch (error) {
      console.error('Apple Pay error:', error);
      Alert.alert(
        'Error',
        'Something went wrong with Apple Pay. Please try again.',
        [{ text: 'OK' }]
      );
    } finally {
      setIsProcessing(false);
    }
  };

  return (
    <View className="flex-1 bg-emerald-600">
      {/* Amount input and other components */}

      {/* Apple Pay Button - Only show on iOS when available */}
      {isApplePayAvailable && (
        <TouchableOpacity
          className="w-full py-4 rounded-full flex-row items-center justify-center mb-4"
          style={{ backgroundColor: '#000000' }}
          onPress={handleApplePayPress}
          disabled={parseFloat(amount) <= 0 || isProcessing}
        >
          {isProcessing ? (
            <>
              <ActivityIndicator size="small" color="#ffffff" />
              <Text className="text-white text-base font-medium ml-2">Processing...</Text>
            </>
          ) : (
            <>
              <MaterialIcons name="apple" size={24} color="#ffffff" />
              <Text className="text-white text-base font-medium ml-2">Pay</Text>
            </>
          )}
        </TouchableOpacity>
      )}

      {/* Regular card payment button */}
      <TouchableOpacity
        className="w-full py-4 rounded-full flex-row items-center justify-center bg-gray-700"
        onPress={handleCardPayment}
        disabled={parseFloat(amount) <= 0 || isProcessing}
      >
        <MaterialIcons name="credit-card" size={20} color="#ffffff" />
        <Text className="text-white text-base font-medium ml-2">
          Pay with Card
        </Text>
      </TouchableOpacity>
    </View>
  );
}
```

---

## Apple Wallet Card Integration

### Overview

Apple Wallet cards allow users to store transaction receipts and get push notifications for updates.

### Step 1: Generate PKPass Files

#### 1.1 Install Dependencies

```bash
npm install passkit-generator
```

#### 1.2 Create Pass Type ID

1. Go to [Apple Developer Portal](https://developer.apple.com/account)
2. **Certificates, Identifiers & Profiles** ‚Üí **Identifiers**
3. Click **+** ‚Üí Select **Pass Type IDs**
4. Create:
   ```
   Identifier: pass.com.bountyexpo.receipt
   Description: BountyExpo Transaction Receipt
   ```

#### 1.3 Generate Pass Certificate

1. In Pass Type ID details, click **Create Certificate**
2. Create CSR in Keychain Access (Mac only):
   - Keychain Access ‚Üí Certificate Assistant ‚Üí Request Certificate from CA
   - Save to disk: `BountyExpoPass.certSigningRequest`
3. Upload CSR and download certificate: `pass.cer`
4. Import certificate into Keychain Access
5. Export as `.p12` file with password

#### 1.4 Create Apple Wallet Service

Create `services/api/src/services/apple-wallet-service.ts`:

```typescript
import { createPass } from 'passkit-generator';
import fs from 'fs';
import path from 'path';

export interface PassData {
  transactionId: string;
  bountyTitle: string;
  amount: number;
  date: string;
  type: 'escrow' | 'release' | 'refund';
  senderName: string;
  recipientName?: string;
}

export class AppleWalletService {
  private certificatePath: string;
  private wwdrPath: string;
  private passTypeId: string;
  private teamId: string;

  constructor() {
    this.certificatePath = process.env.APPLE_PASS_CERTIFICATE_PATH || '';
    this.wwdrPath = process.env.APPLE_WWDR_CERTIFICATE_PATH || '';
    this.passTypeId = process.env.APPLE_PASS_TYPE_ID || 'pass.com.bountyexpo.receipt';
    this.teamId = process.env.APPLE_TEAM_ID || '';
  }

  /**
   * Generate PKPass file for transaction receipt
   */
  async generateTransactionPass(data: PassData): Promise<Buffer> {
    try {
      const pass = await createPass({
        model: path.resolve(__dirname, '../../assets/passes/BountyReceipt.pass'),
        certificates: {
          wwdr: fs.readFileSync(this.wwdrPath),
          signerCert: fs.readFileSync(this.certificatePath),
          signerKey: {
            keyFile: fs.readFileSync(this.certificatePath),
            passphrase: process.env.APPLE_PASS_CERTIFICATE_PASSWORD || '',
          },
        },
        overrides: {
          serialNumber: data.transactionId,
          description: `BountyExpo ${data.type} Receipt`,
        },
      });

      // Set pass data
      const typeLabel = this.getTypeLabel(data.type);
      
      pass.primaryFields.push({
        key: 'amount',
        label: 'Amount',
        value: `$${data.amount.toFixed(2)}`,
        currencyCode: 'USD',
      });

      pass.secondaryFields.push(
        {
          key: 'bounty',
          label: 'Bounty',
          value: data.bountyTitle,
        },
        {
          key: 'type',
          label: 'Type',
          value: typeLabel,
        }
      );

      pass.auxiliaryFields.push(
        {
          key: 'sender',
          label: 'From',
          value: data.senderName,
        },
        {
          key: 'date',
          label: 'Date',
          value: data.date,
          dateStyle: 'PKDateStyleShort',
          timeStyle: 'PKDateStyleShort',
        }
      );

      if (data.recipientName) {
        pass.backFields.push({
          key: 'recipient',
          label: 'To',
          value: data.recipientName,
        });
      }

      pass.backFields.push(
        {
          key: 'transactionId',
          label: 'Transaction ID',
          value: data.transactionId,
        },
        {
          key: 'support',
          label: 'Support',
          value: 'support@bountyexpo.com',
        }
      );

      // Generate the pass buffer
      const buffer = pass.getAsBuffer();
      
      console.log(`‚úÖ Generated Apple Wallet pass for transaction ${data.transactionId}`);
      
      return buffer;

    } catch (error) {
      console.error('Error generating Apple Wallet pass:', error);
      throw error;
    }
  }

  private getTypeLabel(type: string): string {
    switch (type) {
      case 'escrow':
        return 'Payment Held';
      case 'release':
        return 'Payment Received';
      case 'refund':
        return 'Refund Processed';
      default:
        return type;
    }
  }

  /**
   * Send push notification to update pass
   */
  async updatePass(serialNumber: string, updates: any): Promise<boolean> {
    try {
      // Apple Wallet push notifications require:
      // 1. Pass serial number
      // 2. Push token from device
      // 3. Apple Push Notification service
      
      // TODO: Implement APNs push notification
      console.log(`üì≤ Sending update notification for pass ${serialNumber}`);
      
      return true;
    } catch (error) {
      console.error('Error updating pass:', error);
      return false;
    }
  }
}

export const appleWalletService = new AppleWalletService();
```

#### 1.5 Add Pass Download Endpoint

Update `services/api/src/index.ts`:

```typescript
import { appleWalletService } from './services/apple-wallet-service';

// Add Apple Wallet pass download endpoint
fastify.get('/wallet/pass/:transactionId', {
  preHandler: authMiddleware
}, async (request: AuthenticatedRequest, reply) => {
  try {
    const { transactionId } = request.params as { transactionId: string };
    
    // Get transaction details from database
    // const transaction = await getTransaction(transactionId);
    
    const passData = {
      transactionId,
      bountyTitle: 'Example Bounty',
      amount: 100.00,
      date: new Date().toISOString(),
      type: 'release' as const,
      senderName: 'John Doe',
      recipientName: 'Jane Smith',
    };

    const passBuffer = await appleWalletService.generateTransactionPass(passData);

    reply
      .header('Content-Type', 'application/vnd.apple.pkpass')
      .header('Content-Disposition', `attachment; filename="bounty-receipt-${transactionId}.pkpass"`)
      .send(passBuffer);

  } catch (error) {
    console.error('Error generating pass:', error);
    return reply.code(500).send({ error: 'Failed to generate pass' });
  }
});
```

#### 1.6 Frontend - Add to Wallet Button

```typescript
import { Linking, Platform } from 'react-native';

const handleAddToWallet = async (transactionId: string) => {
  if (Platform.OS !== 'ios') {
    Alert.alert('Not Available', 'Apple Wallet is only available on iOS');
    return;
  }

  try {
    const response = await fetch(
      `${API_URL}/wallet/pass/${transactionId}`,
      {
        headers: {
          'Authorization': `Bearer ${authToken}`,
        },
      }
    );

    if (!response.ok) {
      throw new Error('Failed to download pass');
    }

    const passUrl = response.url;
    
    // Open the pass in Apple Wallet
    const supported = await Linking.canOpenURL(passUrl);
    
    if (supported) {
      await Linking.openURL(passUrl);
    } else {
      Alert.alert('Error', 'Unable to open Apple Wallet');
    }

  } catch (error) {
    console.error('Error adding to wallet:', error);
    Alert.alert('Error', 'Failed to add to Apple Wallet');
  }
};

// In your transaction receipt UI
<TouchableOpacity onPress={() => handleAddToWallet(transaction.id)}>
  <Text>Add to Apple Wallet</Text>
</TouchableOpacity>
```

---

## External Stripe Integration Requirements

### Overview

For production deployment, you'll need to set up external Stripe integration components.

### 1. Stripe Account Requirements

#### Business Information
- Legal business name
- Business type (LLC, Corporation, etc.)
- Tax ID (EIN or SSN)
- Business address
- Bank account for payouts
- Business representative information

#### Verification Documents
- Photo ID for business representative
- Business registration documents
- Bank account verification (micro-deposits or instant verification)

### 2. Stripe Connect Express Accounts

Hunter accounts use Stripe Connect Express, which requires:

- Legal name
- Date of birth
- Last 4 digits of SSN
- Bank account information
- Address

### 3. Payment Method Configuration

#### Enable Payment Methods in Stripe Dashboard

1. **Dashboard** ‚Üí **Settings** ‚Üí **Payment methods**
2. Enable:
   - Cards (Visa, Mastercard, Amex)
   - Apple Pay (for iOS)
   - Google Pay (for Android)
   - ACH Direct Debit (optional)

### 4. Webhooks Configuration

Set up webhooks for real-time payment updates:

```
Webhook URL: https://your-domain.com/webhooks/stripe

Events to subscribe:
- payment_intent.succeeded
- payment_intent.payment_failed
- payment_intent.canceled
- transfer.created
- transfer.failed
- refund.created
- refund.updated
- account.updated
- account.external_account.created
```

### 5. Fraud Prevention

Enable Stripe Radar for fraud prevention:

1. **Dashboard** ‚Üí **Radar**
2. Configure rules:
   - Block high-risk payments
   - Review suspicious transactions
   - Set velocity limits
   - Enable 3D Secure for high-value transactions

### 6. Tax Configuration

Set up tax collection if applicable:

1. **Dashboard** ‚Üí **Settings** ‚Üí **Tax**
2. Configure:
   - Tax ID collection
   - Automatic tax calculation
   - Tax reporting

---

## Testing

### Test Mode

Use Stripe test keys for development:

```bash
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
```

### Apple Pay Test Cards

In iOS Simulator, add test cards:
- Settings ‚Üí Wallet & Apple Pay
- Add Card ‚Üí Use test card: 4242 4242 4242 4242

### Test Scenarios

1. **Successful Payment**
   - Amount: Any valid amount
   - Card: 4242 4242 4242 4242
   - Expected: Payment succeeds

2. **Insufficient Funds**
   - Card: 4000 0000 0000 9995
   - Expected: Payment fails with error

3. **Authentication Required**
   - Card: 4000 0025 0000 3155
   - Expected: 3D Secure challenge presented

---

## Production Deployment

### Pre-Launch Checklist

- [ ] Switch to live Stripe API keys
- [ ] Complete Stripe account activation
- [ ] Verify Apple Merchant ID registration
- [ ] Test Apple Pay with real credit card
- [ ] Configure production webhooks
- [ ] Set up fraud prevention rules
- [ ] Test Apple Wallet pass generation
- [ ] Verify email receipt delivery
- [ ] Enable monitoring and alerting
- [ ] Complete security audit
- [ ] Update Terms of Service
- [ ] Update Privacy Policy

### Security Best Practices

1. **Never log sensitive data**
   - Don't log full card numbers
   - Don't log CVV codes
   - Don't log API keys

2. **Use HTTPS everywhere**
   - All API endpoints must use HTTPS
   - Validate SSL certificates

3. **Implement rate limiting**
   - Limit payment attempts per user
   - Detect and block suspicious activity

4. **Regular security audits**
   - Review access logs
   - Monitor for unusual patterns
   - Keep dependencies updated

---

## Troubleshooting

### Apple Pay Issues

**"Apple Pay is not available"**
- Check if device supports Apple Pay (iPhone 6+)
- Verify at least one card is added to Wallet
- Check iOS version (iOS 13+ required)

**"Payment authorization failed"**
- Verify Face ID/Touch ID is enabled
- Check device has internet connection
- Ensure Merchant ID is correctly configured

**"Invalid Merchant ID"**
- Verify Merchant ID matches in:
  - Apple Developer Portal
  - Stripe Dashboard
  - app.json configuration
  - Backend .env file

### Apple Wallet Issues

**"Unable to add pass to Wallet"**
- Verify pass certificate is valid
- Check WWDR certificate is up to date
- Ensure pass.json is properly formatted
- Verify signing process completed without errors

**"Pass not updating"**
- Check push notification configuration
- Verify serial numbers match
- Ensure device has internet connection
- Verify APNs certificate is valid

---

## Additional Resources

- [Stripe Apple Pay Guide](https://stripe.com/docs/apple-pay)
- [Apple Pay Programming Guide](https://developer.apple.com/documentation/passkit/apple_pay)
- [Apple Wallet Developer Guide](https://developer.apple.com/wallet/)
- [PassKit Package Format Reference](https://developer.apple.com/library/archive/documentation/UserExperience/Reference/PassKit_Bundle/Chapters/Introduction.html)

---

## Summary

This guide provides complete integration instructions for:

‚úÖ Apple Pay payment processing with Stripe  
‚úÖ Apple Wallet pass generation for receipts  
‚úÖ External Stripe configuration requirements  
‚úÖ Production deployment checklist  
‚úÖ Comprehensive testing procedures  
‚úÖ Security best practices  
‚úÖ Troubleshooting common issues  

Both integrations enhance the user experience by providing:
- Faster, more secure payments
- Convenient receipt storage
- Push notifications for transaction updates
- Higher payment conversion rates
- Better user trust and satisfaction
